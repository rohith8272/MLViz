<!DOCTYPE html>
<html>
<head>
  <title>MAVLink Health Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #0c1a32 100%);
      min-height: 100vh;
      color: white;
    }

    .header {
      padding: 20px;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 300;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .controls {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .btn.primary {
      background: #4CAF50;
      border-color: #4CAF50;
    }

    .btn.danger {
      background: #f44336;
      border-color: #f44336;
    }

    .dashboard {
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .widget {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 20px;
      position: relative;
      transition: all 0.3s ease;
      animation: slideInUp 0.5s ease-out;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .widget:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .widget-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem;
      font-weight: 500;
    }

    .widget-close {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .widget-close:hover {
      background: #f44336;
    }

    .icon {
      font-size: 1.5rem;
    }

    .data-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px 0;
    }

    .data-label {
      font-weight: 500;
      opacity: 0.8;
    }

    .data-value {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .bar-container {
      margin: 10px 0;
    }

    .bar {
      width: 100%;
      height: 12px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      height: 100%;
      width: 0%;
      transition: width 0.3s ease-out;
      border-radius: 6px;
    }

    .servo-bar { background: linear-gradient(90deg, #FFA726, #FF9800); }
    .vibration-bar { background: linear-gradient(90deg, #EF5350, #F44336); }
    .battery-bar { background: linear-gradient(90deg, #66BB6A, #4CAF50); }
    .signal-bar { background: linear-gradient(90deg, #42A5F5, #2196F3); }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-good { background: #4CAF50; }
    .status-warning { background: #FF9800; }
    .status-error { background: #f44336; }

/* Aircraft Digital Twin Styles */
    .aircraft-container {
      position: relative;
      width: 100%;
      height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
      border-radius: 12px;
      margin: 20px 0;
    }

    .aircraft-svg {
      width: 200px;
      height: 200px;
      transform-origin: center center;
      transition: transform 0.3s ease;
      filter: drop-shadow(0 0 10px rgba(74, 175, 79, 0.5));
    }

    .sensor-overlay {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      color: white;
      backdrop-filter: blur(10px);
      pointer-events: none;
      z-index: 10;
      min-width: 80px;
      text-align: center;
    }

    .sensor-overlay.gps {
      top: 10px;
      left: 10px;
    }

    .sensor-overlay.battery {
      top: 10px;
      right: 10px;
    }

    .sensor-overlay.altitude {
      bottom: 10px;
      left: 10px;
    }

    .sensor-overlay.speed {
      bottom: 10px;
      right: 10px;
    }

    .sensor-overlay.attitude {
      top: 50%;
      left: 10px;
      transform: translateY(-50%);
    }

    .sensor-overlay.mode {
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
    }

    .attitude-indicators {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .attitude-dial {
      position: relative;
      width: 80px;
      height: 80px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.05);
    }

    .attitude-needle {
      position: absolute;
      width: 2px;
      height: 30px;
      background: #4CAF50;
      transform-origin: bottom center;
      transition: transform 0.3s ease;
    }

    .attitude-label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      opacity: 0.8;
    }

    .attitude-value {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      font-weight: bold;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      color: white;
    }

    .modal h3 {
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .widget-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .widget-option {
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .widget-option:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.02);
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    #connectionDot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #f44336;
      animation: pulse 2s infinite;
    }

    .connected #connectionDot {
      background: #4CAF50;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>
      <span class="icon">üöÅ</span>
      MAVLink Viz.
    </h1>
    <div class="controls">
      <div class="connection-status" id="connectionStatus">
        <div id="connectionDot"></div>
        <span>Disconnected</span>
      </div>
      <button class="btn primary" onclick="openAddWidgetModal()">+ Add Widget</button>
      <button class="btn" onclick="toggleAllWidgets()">Toggle All</button>
    </div>
  </div>

  <div class="dashboard" id="dashboard">
    <!-- Widgets will be dynamically added here -->
  </div>

  <!-- Add Widget Modal -->
  <div class="modal" id="addWidgetModal">
    <div class="modal-content">
      <h3>Add Widget</h3>
      <div class="widget-grid">
        <div class="widget-option" onclick="addWidget('gps')">
          <div class="icon">üìç</div>
          <div>GPS Position</div>
        </div>
        <div class="widget-option" onclick="addWidget('digitaltwin')">
          <div class="icon">üõ©Ô∏è</div>
          <div>Digital Twin</div>
        </div>
        <div class="widget-option" onclick="addWidget('servo')">
          <div class="icon">‚öôÔ∏è</div>
          <div>Servo Outputs</div>
        </div>
        <div class="widget-option" onclick="addWidget('vibration')">
          <div class="icon">üìä</div>
          <div>Vibrations</div>
        </div>
        <div class="widget-option" onclick="addWidget('battery')">
          <div class="icon">üîã</div>
          <div>Battery Status</div>
        </div>
        <div class="widget-option" onclick="addWidget('attitude')">
          <div class="icon">‚úàÔ∏è</div>
          <div>Attitude</div>
        </div>
        <div class="widget-option" onclick="addWidget('system')">
          <div class="icon">üíª</div>
          <div>System Status</div>
        </div>
        <div class="widget-option" onclick="addWidget('rc')">
          <div class="icon">üì°</div>
          <div>RC Channels</div>
        </div>
        <div class="widget-option" onclick="addWidget('mission')">
          <div class="icon">üéØ</div>
          <div>Mission Status</div>
        </div>
        <div class="widget-option" onclick="addWidget('fence')">
          <div class="icon">üéØ</div>
          <div>Fence Status</div>
        </div>
      </div>
      <div style="text-align: center;">
        <button class="btn" onclick="closeAddWidgetModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div style="text-align: center; margin-top: 20px; font-size: 14px; color: #666;">
    <p>
        ¬© 2025 MLViz ¬∑
        <a href="https://github.com/yourusername/your-repo" target="_blank" style="color: #007acc; text-decoration: none;">
            View on GitHub
        </a>
    </p>
</div>

  <script>
    let widgets = new Map();
    let ws = null;
    let connected = false;

    // Initialize WebSocket connection
    function initWebSocket() {
      ws = new WebSocket(`ws://${location.host}`);
      
      ws.onopen = () => {
        console.log("WebSocket connected");
        connected = true;
        updateConnectionStatus();
      };

      ws.onclose = () => {
        console.log("WebSocket disconnected");
        connected = false;
        updateConnectionStatus();
        // Attempt to reconnect after 3 seconds
        setTimeout(initWebSocket, 3000);
      };

      ws.onerror = (error) => {
        console.error("WebSocket error:", error);
        connected = false;
        updateConnectionStatus();
      };

      ws.onmessage = (evt) => {
        try {
          const data = JSON.parse(evt.data);
          //console.log(data.payload);
          updateWidgets(data.payload || data);
        } catch (error) {
          console.error("Error parsing message:", error);
        }
      };
    }

    function updateConnectionStatus() {
      const status = document.getElementById('connectionStatus');
      const dot = document.getElementById('connectionDot');
      
      if (connected) {
        status.className = 'connection-status connected';
        status.querySelector('span').textContent = 'Connected';
      } else {
        status.className = 'connection-status';
        status.querySelector('span').textContent = 'Disconnected';
      }
    }

    function openAddWidgetModal() {
      document.getElementById('addWidgetModal').classList.add('active');
    }

    function closeAddWidgetModal() {
      document.getElementById('addWidgetModal').classList.remove('active');
    }

    function addWidget(type) {
      const widgetId = `widget_${type}_${Date.now()}`;
      const widget = createWidget(type, widgetId);
      
      if (widget) {
        widgets.set(widgetId, { type, element: widget });
        document.getElementById('dashboard').appendChild(widget);
        closeAddWidgetModal();
      }
    }

    function removeWidget(widgetId) {
      const widget = widgets.get(widgetId);
      if (widget) {
        widget.element.style.animation = 'slideOutDown 0.3s ease-in';
        setTimeout(() => {
          if (widget.element.parentNode) {
            widget.element.parentNode.removeChild(widget.element);
          }
          widgets.delete(widgetId);
        }, 300);
      }
    }

    function createWidget(type, widgetId) {
      const widget = document.createElement('div');
      widget.className = 'widget';
      widget.id = widgetId;

      const widgetConfigs = {
         digitaltwin: {
          icon: 'üõ©Ô∏è',
          title: 'Aircraft Digital Twin',
          content: `
            <div class="aircraft-container">
              <div class="sensor-overlay gps">
                <div style="font-weight: bold;">GPS</div>
                <div id="${widgetId}_status">No Fix</div>
                <div id="${widgetId}_sats">0 sats</div>
              </div>
              
              <div class="sensor-overlay battery">
                <div style="font-weight: bold;">Battery</div>
                <div id="${widgetId}_battery_level">0%</div>
                <div id="${widgetId}_voltage">0.0V</div>
              </div>
              
              <div class="sensor-overlay altitude">
                <div style="font-weight: bold;">Altitude</div>
                <div id="${widgetId}_altitude">0 m</div>
              </div>
              
              <div class="sensor-overlay speed">
                <div style="font-weight: bold;">Speed</div>
                <div id="${widgetId}_speed">0 m/s</div>
              </div>
              
              <div class="sensor-overlay attitude">
                <div style="font-weight: bold;">Attitude</div>
                <div>R: <span id="${widgetId}_roll_val">0¬∞</span></div>
                <div>P: <span id="${widgetId}_pitch_val">0¬∞</span></div>
                <div>Y: <span id="${widgetId}_yaw_val">0¬∞</span></div>
              </div>
              
              <div class="sensor-overlay mode">
                <div style="font-weight: bold;">Mode</div>
                <div id="${widgetId}_flight_mode">Unknown</div>
              </div>
              
              <svg class="aircraft-svg" id="${widgetId}_aircraft" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <!-- Aircraft body -->
                <ellipse cx="100" cy="100" rx="8" ry="45" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
                
                <!-- Wings -->
                <ellipse cx="100" cy="90" rx="60" ry="8" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
                
                <!-- Tail -->
                <ellipse cx="100" cy="140" rx="15" ry="6" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
                
                <!-- Nose -->
                <circle cx="100" cy="55" r="6" fill="#66BB6A" stroke="#2E7D32" stroke-width="2"/>
                
                <!-- Navigation lights -->
                <circle cx="40" cy="90" r="3" fill="#f44336"/>
                <circle cx="160" cy="90" r="3" fill="#4CAF50"/>
                <circle cx="100" cy="145" r="2" fill="#FFF"/>
                
                <!-- Propeller -->
                <g id="${widgetId}_propeller" style="transform-origin: 100px 55px;">
                  <line x1="85" y1="55" x2="115" y2="55" stroke="#333" stroke-width="3" opacity="0.7"/>
                  <line x1="100" y1="40" x2="100" y2="70" stroke="#333" stroke-width="3" opacity="0.7"/>
                </g>
              </svg>
            </div>
            
            <div class="attitude-indicators">
              <div class="attitude-dial">
                <div class="attitude-needle" id="${widgetId}_roll_needle"></div>
                <div class="attitude-label">Roll</div>
                <div class="attitude-value" id="${widgetId}_roll_display">0¬∞</div>
              </div>
              <div class="attitude-dial">
                <div class="attitude-needle" id="${widgetId}_pitch_needle"></div>
                <div class="attitude-label">Pitch</div>
                <div class="attitude-value" id="${widgetId}_pitch_display">0¬∞</div>
              </div>
              <div class="attitude-dial">
                <div class="attitude-needle" id="${widgetId}_yaw_needle"></div>
                <div class="attitude-label">Yaw</div>
                <div class="attitude-value" id="${widgetId}_yaw_display">0¬∞</div>
              </div>
            </div>
          `
        },
        gps: {
          icon: 'üìç',
          title: 'GPS Position',
          content: `
            <div class="data-row">
              <span class="data-label">Status:</span>
              <span class="data-value"><span class="status-indicator status-error"></span><span id="${widgetId}_status">No Fix</span></span>
            </div>
            <div class="data-row">
              <span class="data-label">Latitude:</span>
              <span class="data-value" id="${widgetId}_lat">0.000000</span>
            </div>
            <div class="data-row">
              <span class="data-label">Longitude:</span>
              <span class="data-value" id="${widgetId}_lon">0.000000</span>
            </div>
            <div class="data-row">
              <span class="data-label">Altitude:</span>
              <span class="data-value" id="${widgetId}_alt">0 m</span>
            </div>
            <div class="data-row">
              <span class="data-label">Satellites:</span>
              <span class="data-value" id="${widgetId}_sat">0</span>
            </div>
          `
        },
        servo: {
          icon: '‚öôÔ∏è',
          title: 'Servo Outputs',
          content: `
            ${[1,2,3,4].map(i => `
              <div class="bar-container">
                <div class="data-label">Servo ${i}: <span id="${widgetId}_servo${i}_val">1000</span>¬µs</div>
                <div class="bar">
                  <div class="bar-fill servo-bar" id="${widgetId}_servo${i}"></div>
                </div>
              </div>
            `).join('')}
          `
        },
        vibration: {
          icon: 'üìä',
          title: 'Vibration Levels',
          content: `
            ${['X', 'Y', 'Z'].map(axis => `
              <div class="bar-container">
                <div class="data-label">Vibration ${axis}: <span id="${widgetId}_vib${axis}_val">0.00</span></div>
                <div class="bar">
                  <div class="bar-fill vibration-bar" id="${widgetId}_vib${axis}"></div>
                </div>
              </div>
            `).join('')}
          `
        },
        battery: {
          icon: 'üîã',
          title: 'Battery Status',
          content: `
            <div class="data-row">
              <span class="data-label">Voltage:</span>
              <span class="data-value" id="${widgetId}_voltage">0.0 V</span>
            </div>
            <div class="data-row">
              <span class="data-label">Current:</span>
              <span class="data-value" id="${widgetId}_current">0.0 A</span>
            </div>
            <div class="bar-container">
              <div class="data-label">Remaining: <span id="${widgetId}_remaining">0%</span></div>
              <div class="bar">
                <div class="bar-fill battery-bar" id="${widgetId}_battery"></div>
              </div>
            </div>
          `
        },
        attitude: {
          icon: '‚úàÔ∏è',
          title: 'Attitude',
          content: `
            <div class="data-row">
              <span class="data-label">Roll:</span>
              <span class="data-value" id="${widgetId}_roll">0.0¬∞</span>
            </div>
            <div class="data-row">
              <span class="data-label">Pitch:</span>
              <span class="data-value" id="${widgetId}_pitch">0.0¬∞</span>
            </div>
            <div class="data-row">
              <span class="data-label">Yaw:</span>
              <span class="data-value" id="${widgetId}_yaw">0.0¬∞</span>
            </div>
          `
        },
        system: {
          icon: 'üíª',
          title: 'System Status',
          content: `
            <div class="data-row">
              <span class="data-label">Mode:</span>
              <span class="data-value" id="${widgetId}_mode">Unknown</span>
            </div>
            <div class="data-row">
              <span class="data-label">Armed:</span>
              <span class="data-value"><span class="status-indicator status-error"></span><span id="${widgetId}_armed">Disarmed</span></span>
            </div>
            <div class="data-row">
              <span class="data-label">CPU Load:</span>
              <span class="data-value" id="${widgetId}_cpu">0%</span>
            </div>
          `
        },
        rc: {
          icon: 'üì°',
          title: 'RC Channels',
          content: `
            ${[1,2,3,4].map(i => `
              <div class="bar-container">
                <div class="data-label">CH${i}: <span id="${widgetId}_ch${i}_val">1500</span></div>
                <div class="bar">
                  <div class="bar-fill signal-bar" id="${widgetId}_ch${i}"></div>
                </div>
              </div>
            `).join('')}
          `
        },
        mission: {
          icon: 'üéØ',
          title: 'Mission Status',
          content: `
            <div class="data-row">
              <span class="data-label">Current WP:</span>
              <span class="data-value" id="${widgetId}_current_wp">0</span>
            </div>
            <div class="data-row">
              <span class="data-label">Total WPs:</span>
              <span class="data-value" id="${widgetId}_total_wp">0</span>
            </div>
            <div class="data-row">
              <span class="data-label">Distance:</span>
              <span class="data-value" id="${widgetId}_distance">0 m</span>
            </div>
          `
        },
        fence: {
          icon: 'üéØ',
          title: 'Fence Status',
          content: `
            <div class="data-row">
              <span class="data-label">fence status:</span>
              <span class="data-value" id="${widgetId}_status">0</span>
            </div>
            <div class="data-row">
              <span class="data-label">count:</span>
              <span class="data-value" id="${widgetId}_count">0</span>
            </div>
            <div class="data-row">
              <span class="data-label">types:</span>
              <span class="data-value" id="${widgetId}_type">0 m</span>
            </div>
          `
        }

      };

      const config = widgetConfigs[type];
      if (!config) return null;

      widget.innerHTML = `
        <div class="widget-header">
          <div class="widget-title">
            <span class="icon">${config.icon}</span>
            ${config.title}
          </div>
          <button class="widget-close" onclick="removeWidget('${widgetId}')">&times;</button>
        </div>
        ${config.content}
      `;

      return widget;
    }

    function updateWidgets(data) {
      widgets.forEach((widget, widgetId) => {
        const { type } = widget;
        
        switch (type) {
          case 'digitaltwin':
            updateDigitalTwinWidget(widgetId, data);
            break;
          case 'gps':
            updateGPSWidget(widgetId, data);
            break;
          case 'servo':
            updateServoWidget(widgetId, data);
            break;
          case 'vibration':
            updateVibrationWidget(widgetId, data);
            break;
          case 'battery':
            updateBatteryWidget(widgetId, data);
            break;
          case 'attitude':
            updateAttitudeWidget(widgetId, data);
            break;
          case 'system':
            updateSystemWidget(widgetId, data);
            break;
          case 'rc':
            updateRCWidget(widgetId, data);
            break;
          case 'mission':
            updateMissionWidget(widgetId, data);
            break;
          case 'fence':
            updateFenceWidget(widgetId, data);
            break;
        }
      });
    }
    
    function updateDigitalTwinWidget(widgetId, data) {
      
      const aircraft = document.getElementById(`${widgetId}_aircraft`);
      const propeller = document.getElementById(`${widgetId}_propeller`);
      

 
      if (data.fixType != undefined) {
        
        //const indicator = statusEl.parentElement.querySelector('.status-indicator');
        const fixTypes = ['No Fix', 'No Fix', '2D Fix', '3D Fix', 'DGPS', 'RTK Float', 'RTK Fixed'];
        document.getElementById(`${widgetId}_status`) = fixTypes[data.fixType] || 'Unknown';
      }


      if (data.satellitesVisible !== undefined) {
        const satEl = document.getElementById(`${widgetId}_sats`);
        if (satEl) satEl.textContent = `${data.satellitesVisible}`;
      }
      
      if (data.batteryRemaining !== undefined) {
        const batteryEl = document.getElementById(`${widgetId}_battery_level`);
        if (batteryEl) batteryEl.textContent = `${data.batteryRemaining}%`;
      }
      
      if (data.voltageV !== undefined) {
        const voltageEl = document.getElementById(`${widgetId}_voltage`);
        if (voltageEl) voltageEl.textContent = `${data.voltageV.toFixed(1)}V`;
      }
      
      if (data.alt !== undefined) {
        const altEl = document.getElementById(`${widgetId}_altitude`);
        if (altEl) altEl.textContent = `${data.alt.toFixed(1)} m`;
      }
      
      if (data.groundspeed !== undefined) {
        const speedEl = document.getElementById(`${widgetId}_speed`);
        if (speedEl) speedEl.textContent = `${data.groundspeed.toFixed(1)} m/s`;
      }
      
      if (data.mode !== undefined) {
        const modeEl = document.getElementById(`${widgetId}_flight_mode`);
        if (modeEl) modeEl.textContent = data.mode;
      }

            if (aircraft && (data.roll !== undefined || data.pitch !== undefined || data.yaw !== undefined)) {
        const roll = data.roll* 180 / Math.PI || telemetryData.roll || 0;
        const pitch = data.pitch* 180 / Math.PI || telemetryData.pitch || 0;
        const yaw = data.yaw* 180 / Math.PI || telemetryData.yaw || 0;
        
        // Update aircraft orientation
        aircraft.style.transform = `rotate(${roll}deg) rotateX(${pitch}deg) rotateZ(${yaw}deg)`;
        
        // Animate propeller
        if (propeller) {
          propeller.style.animation = 'spin 0.1s linear infinite';
        }
      }
      
      // Update attitude indicators
    ['roll', 'pitch', 'yaw'].forEach(axis => {
      const valueRad = data[axis] !== undefined ? data[axis] : telemetryData[axis];
      
  if (valueRad !== undefined) {
    // Convert radians to degrees
    const valueDeg = valueRad * 180 / Math.PI;

    const needle = document.getElementById(`${widgetId}_${axis}_needle`);
    const display = document.getElementById(`${widgetId}_${axis}_display`);
    const overlay = document.getElementById(`${widgetId}_${axis}_val`);
    
    if (needle) needle.style.transform = `rotate(${valueDeg}deg)`;
    if (display) display.textContent = `${valueDeg.toFixed(1)}¬∞`;
    if (overlay) overlay.textContent = `${valueDeg.toFixed(1)}¬∞`;
  }
});
      
    }

    function updateFenceWidget(widgetId, data) {
      if (data.breachStatus != null) {
        document.getElementById(`${widgetId}_status`).textContent = data.breachStatus;
      }
      if (data.breachCount != null) {
        document.getElementById(`${widgetId}_count`).textContent = data.breachCount;
      }
      if (data.breachType != null) {
        document.getElementById(`${widgetId}_type`).textContent = data.breachType;
      }
    }

    function updateGPSWidget(widgetId, data) {
      if (data.lat != null) {
        document.getElementById(`${widgetId}_lat`).textContent = data.lat.toFixed(2)* 1e-7;
      }
      if (data.lon != null) {
        document.getElementById(`${widgetId}_lon`).textContent = data.lon.toFixed(2)* 1e-7;
      }
      if (data.alt != null) {
        document.getElementById(`${widgetId}_alt`).textContent = `${data.alt.toFixed(1)} m`;
      }
      if (data.satellitesVisible != null) {
        document.getElementById(`${widgetId}_sat`).textContent = data.satellitesVisible;
      }
      if (data.fixType != null) {
        const statusEl = document.getElementById(`${widgetId}_status`);
        const indicator = statusEl.parentElement.querySelector('.status-indicator');
        const fixTypes = ['No Fix', 'No Fix', '2D Fix', '3D Fix', 'DGPS', 'RTK Float', 'RTK Fixed'];
        statusEl.textContent = fixTypes[data.fixType] || 'Unknown';
        
        if (data.fixType >= 3) {
          indicator.className = 'status-indicator status-good';
        } else if (data.fixType >= 2) {
          indicator.className = 'status-indicator status-warning';
        } else {
          indicator.className = 'status-indicator status-error';
        }
      }
    }

    function updateServoWidget(widgetId, data) {
      for (let i = 1; i <= 4; i++) {
        const key = `servo${i}Raw`;
        if (data[key] != null) {
          const norm = Math.max(0, Math.min(1, (data[key] - 1000) / 1000));
          document.getElementById(`${widgetId}_servo${i}`).style.width = (norm * 100) + '%';
          document.getElementById(`${widgetId}_servo${i}_val`).textContent = data[key];
        }
      }
    }

    function updateVibrationWidget(widgetId, data) {
      ['X', 'Y', 'Z'].forEach(axis => {
        const key = `vibration${axis}`;
        if (data[key] != null) {
          const value = Math.abs(data[key]);
          const percent = Math.min(100, value * 20);
          document.getElementById(`${widgetId}_vib${axis}`).style.width = percent + '%';
          document.getElementById(`${widgetId}_vib${axis}_val`).textContent = value.toFixed(2);
        }
      });
    }

    function updateBatteryWidget(widgetId, data) {
      if (data.voltageV != null) {
        document.getElementById(`${widgetId}_voltage`).textContent = `${data.voltageV.toFixed(1)} V`;
      }
      if (data.currentA != null) {
        document.getElementById(`${widgetId}_current`).textContent = `${data.currentA.toFixed(1)} A`;
      }
      if (data.batteryRemaining != null) {
        const percent = data.batteryRemaining;
        document.getElementById(`${widgetId}_remaining`).textContent = `${percent}%`;
        document.getElementById(`${widgetId}_battery`).style.width = percent + '%';
      }
    }

    function updateAttitudeWidget(widgetId, data) {
      if (data.roll != null) {
        document.getElementById(`${widgetId}_roll`).textContent = `${(data.roll * 180 / Math.PI).toFixed(1)}¬∞`;
      }
      if (data.pitch != null) {
        document.getElementById(`${widgetId}_pitch`).textContent = `${(data.pitch * 180 / Math.PI).toFixed(1)}¬∞`;
      }
      if (data.yaw != null) {
        document.getElementById(`${widgetId}_yaw`).textContent = `${(data.yaw * 180 / Math.PI).toFixed(1)}¬∞`;
      }
    }

    function updateSystemWidget(widgetId, data) {
      if (data.customMode != null) {
        document.getElementById(`${widgetId}_mode`).textContent = data.customMode;
      }
      if (data.baseMode != null) {
        const armed = (data.baseMode & 128) !== 0;
        const armedEl = document.getElementById(`${widgetId}_armed`);
        const indicator = armedEl.parentElement.querySelector('.status-indicator');
        armedEl.textContent = armed ? 'Armed' : 'Disarmed';
        indicator.className = armed ? 'status-indicator status-warning' : 'status-indicator status-good';
      }
      if (data.load != null) {
        document.getElementById(`${widgetId}_cpu`).textContent = `${(data.load / 10).toFixed(0)}%`;
      }
    }

    function updateRCWidget(widgetId, data) {
      for (let i = 1; i <= 4; i++) {
        const key = `chan${i}Raw`;
        if (data[key] != null) {
          const norm = Math.max(0, Math.min(1, (data[key] - 1000) / 1000));
          document.getElementById(`${widgetId}_ch${i}`).style.width = (norm * 100) + '%';
          document.getElementById(`${widgetId}_ch${i}_val`).textContent = data[key];
        }
      }
    }

    function updateMissionWidget(widgetId, data) {
      if (data.seq != null) {
        document.getElementById(`${widgetId}_current_wp`).textContent = data.seq;
      }
      if (data.count != null) {
        document.getElementById(`${widgetId}_total_wp`).textContent = data.count;
      }
      if (data.wpDist != null) {
        document.getElementById(`${widgetId}_distance`).textContent = `${data.wpDist.toFixed(0)} m`;
      }
    }

    function toggleAllWidgets() {
      const dashboard = document.getElementById('dashboard');
      const isHidden = dashboard.style.display === 'none';
      dashboard.style.display = isHidden ? 'grid' : 'none';
    }

    // Initialize with some default widgets
    function initializeDefaultWidgets() {
      ['gps', 'servo', 'vibration', 'battery'].forEach(type => {
        setTimeout(() => addWidget(type), Math.random() * 500);
      });
    }

    // Close modal when clicking outside
    document.getElementById('addWidgetModal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        closeAddWidgetModal();
      }
    });

    // Initialize
    initWebSocket();
    initializeDefaultWidgets();

    // Add some CSS animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideOutDown {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(30px) scale(0.9);
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>